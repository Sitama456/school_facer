### 中断服务是什么？
1. 中断服务程序是CPU响应外部设备请求的一种手段。当设备发生了某个事件需要请求CPU处理时，CPU会暂停当前的执行序列，保护现场，然后根据中断类型调用相应的服务程序去响应设备请求。响应完成后再回到原来被中断的地址，恢复原来的执行序列。
2. 通常把来自CPU外部的异步的打断称为中断，而把来自CPU内部指令执行产生的打断成为异常。比如除0异常，数组访问越界异常。

### 最多有多少个中断服务？
最多有256个中断服务。其中0~20号是x86硬件定义中断，21~31号中断，为Intel保留使用。32~255号中断，是用户自定义中断。

### 怎么建立中断服务机制？
中断服务机制需要软硬件共同提供服务。
1. 初始化可编程中断控制器。这属于硬件的初始化，过程取决于硬件特性。
2. 创建与加载中断描述符表IDT。中断描述符表中保存了每个中断号对应的中断服务例程入口的虚地址，并且记录了每个描述符的特权级别。
3. 加载中断描述符表。这类似于加载全局描述符表，需要记录中断描述符表的起始地址和长度，然后使用lidt指令加载。
举个例子说明，假设CPU在用户态代码发生了除0操作操作。
1. 中断发生，CPU立刻暂停当前程序执行。当前指令执行完毕后，处理器检查特权级，发现实在用户态代码下，需要变换特权级，做栈切换。与此同时，CPU根据中断源对应的中断向量号假设为50，就以此为索引从中断描述符表中取得中断描述符，把其中的中断处理程序入口地址装入CS、IP中。此时硬件已经在内核栈中压入了一些寄存器的值，其中最重要的就是SS ESP CS EIP等寄存器。
2. 进入50号中断服务程序之后，如果CPU没有压入错误号，则人为压入一个0错误号，再压入中断号，接着调用中断总管函数__alltraps。
3. 在中断总管函数__alltraps中，进一步保存通用寄存器，比如ds es fs gs edi esi 等。为C函数trap()运行做准备。
4. 进入C函数trap()中，其参数是一个中断帧的结构体对象，结构体成员就是之前压入栈中的值。在该函数中，进一步调用了中断分发函数trap_dispatch(),其参数也是中断帧trapframe类型。
5. 进入trap_dispatch中，根据中断帧中的中断号判断应该执行那个处理函数，调用具体的处理函数之后，返回到上一层trap函数中。
6. trap()接着往下执行，判断当前进程退出标志或者调度标志被置位，是的话就执行退出或调度，否则就返回到总管函数__alltraps中。
7. 在__alltraps中，当trap函数正常返回后，依次弹出被压栈的寄存器的值，弹出压入的中断向量号和错误码。最后执行iret指令，CPU会根据之前压入的CS判断是否要进行栈切换，继而弹出SS和ESP。之后，就恢复了中断前的执行序列了。

### 中断嵌套是什么？ 怎么处理
1. 中断嵌套是指在处理上一个中断的过程中，又发生了中断，并且该中断的优先级更加高，这时就需要先相应高优先级的中断。
2. 处理方式为:
   - 不处理。在响应中断时直接关中断，确保当前中断不会被别的中断打断。
   - 保存当前中断的现场，处理高优先级的中断。这样中断帧的信息就被层层保存在内核栈中。当高优先级中断响应完成之后，中断返回会回到低优先级中断被打断的地方，继续处理低优先级中断。
  
### 怎样开关中断?
关中断： 使用cld指令
开中断： 使用sti指令