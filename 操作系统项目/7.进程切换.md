### 什么是进程切换？为什么要切换？
1. 进程切换就是当前进程让出CPU执行权给另一个进程。
2. 操作系统为支持进程的并发执行，就必须支持进程切换。进程切换是多任务操作系统必需的基础功能之一。

### 怎么进程进程切换
1. 进程切换都是在内核态完成的。无论是进程主动被切换(sys_yield 阻塞)还是进程在中断时被动地换下处理器，都是在进程已经陷入内核态时进行的。甚至内核线程参与的切换都是在中断的状态下进行的。此时，进程执行的现场被全部保存在中断帧中。
2. 进程的切换，实际上时进程中断后的内核态执行流的切换。不同内核态执行切换时，只需要保存必要的寄存器，确保它再次被换上处理器时能够按照原来的执行流返回即可。
3. 需要保存的必要的寄存器包括通用寄存器、指令指针寄存器、栈指针寄存器和栈帧寄存器，共8个，被定义为PCB中的一个结构体context。切换时，只需要保存旧值，替换新值即可。

### 怎么向目标进程切换
1. 进程的切换不仅包括必需寄存器的保存和恢复，在此之前，还要设置TSS段和页寄存器。
2. 目标进程next通过调度算法被选出来之后。将current指针指向next。current指针是一个永远指向当前运行进程的全局变量。然后更新TSS任务状态段中的内核栈指针为next的栈底指针。加载next进程的cr3寄存器。
3. 最后调用switch_to函数，参数是旧进程指针、新进程指针。它是一个汇编语言的函数，按照C函数调用的约定，在主调函数call时候，会将参数从右到左压入栈，然后压入返回地址。所以在switch_to汇编函数中就是保存和设置寄存器的值。
4. 当switch_to中执行ret指令后，将弹出参数保持参数栈平衡。返回到了目标进程next上次被调度的地方。完成新旧进程切换。